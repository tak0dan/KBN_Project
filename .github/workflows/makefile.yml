name: K_B_N Build Workflow
version: 1.1

# Define directories to ensure they exist
directories:
  - path: KBN_1_prj/K_B_N/Binaries/Linux
  - path: KBN_1_prj/K_B_N/Intermediate/Build/Linux/x64/K_B_NEditor/Development
  - path: KBN_1_prj/K_B_N/Intermediate/Build/Linux/x64/UnrealEditor/Development/K_B_N
  - path: KBN_1_prj/K_B_N/Intermediate/Config/CoalescedSourceConfigs
  - path: KBN_1_prj/K_B_N/Saved/Config/LinuxEditor
  - path: KBN_1_prj/K_B_N/Saved/Logs

# Define placeholder files to create if they don't exist
files:
  - path: KBN_1_prj/K_B_N/Binaries/Linux/K_B_NEditor.target
    content: "# Placeholder for K_B_NEditor.target"
  - path: KBN_1_prj/K_B_N/Intermediate/Config/CoalescedSourceConfigs/GameUserSettings.ini
    content: "[/Script/Engine.GameUserSettings]\n# Placeholder configuration"
  - path: KBN_1_prj/K_B_N/Saved/Config/LinuxEditor/Editor.ini
    content: "[/Script/UnrealEd.EditorSettings]\n# Placeholder editor settings"
  - path: KBN_1_prj/K_B_N/Saved/Logs/K_B_N.log
    content: "# Placeholder log file"

# Tasks to create directories and files
tasks:
  setup-directories:
    description: Create necessary directories if they don't exist
    steps:
      - run: |
          for dir in "${{ directories[*].path }}"; do
            mkdir -p "$dir"
          done
        shell: bash

  setup-files:
    description: Create placeholder files if they don't exist
    steps:
      - run: |
          ${{ for file in files }}
            if [ ! -f "${{ file.path }}" ]; then
              mkdir -p "$(dirname ${{ file.path }})"
              echo "${{ file.content }}" > "${{ file.path }}"
            fi
          ${{ endfor }}
        shell: bash

  setup-unreal:
    description: Set up Unreal Engine project files
    steps:
      - run: |
          # Ensure Setup.sh is executable and run it to download dependencies
          chmod +x Engine/Build/BatchFiles/Linux/Setup.sh
          ./Engine/Build/BatchFiles/Linux/Setup.sh
          # Generate project files for K_B_N
          chmod +x Engine/Build/BatchFiles/Linux/GenerateProjectFiles.sh
          ./Engine/Build/BatchFiles/Linux/GenerateProjectFiles.sh -project="KBN_1_prj/K_B_N/K_B_N.uproject" -game -engine
        shell: bash

  build:
    description: Run the Unreal Engine build process
    needs: [setup-directories, setup-files, setup-unreal]
    steps:
      - run: |
          # Build the K_B_NEditor for Linux
          ./Engine/Build/BatchFiles/Linux/Build.sh K_B_NEditor Linux Development
        shell: bash

# Main workflow
workflow:
  jobs:
    build-job:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
        - task: setup-directories
        - task: setup-files
        - task: setup-unreal
        - task: build
